---
- name: Bootstrap system
  hosts: all
  tasks:
    - name: Install Linuxbrew
      shell: curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh | bash -c
      args:
        creates: /home/linuxbrew/.linuxbrew

    - name: Install apt packages
      become: true
      ansible.builtin.apt:
        name:
          - zsh
        state: present

    - name: Install Zinit
      ansible.builtin.shell: curl -fsSL https://raw.githubusercontent.com/zdharma-continuum/zinit/HEAD/scripts/install.sh | bash -c
      args:
        creates: "{{ ansible_env.HOME }}/.local/share/zinit/zinit.git"

    - name: Configure Zinit
      ansible.builtin.blockinfile:
        path: "{{ ansible_env.HOME }}/.zshrc"
        block: |
          ZSH_THEME="bureau"
          zinit snippet OMZL::git.zsh
          zinit snippet OMZP::git
          zinit cdclear -q
          zinit snippet OMZP::golang
          zinit snippet OMZP::helm
          zinit snippet OMZP::k9s
          zinit snippet OMZP::kubectl
          zinit snippet OMZP::kubectx
          zinit snippet OMZP::node
          zinit snippet OMZP::npm
          zinit snippet OMZP::ssh
          zinit snippet OMZP::vscode
          zinit snippet OMZP::yarn
          zinit snippet OMZL::clipboard.zsh
          zinit snippet OMZL::nvm.zsh
          zinit snippet OMZT::$ZSH_THEME

    - name: Install snap packages
      become: true
      community.general.snap:
        name:
          - discord
          - ghostty
          - spotify
          - steam
        state: present

    - name: Install brew packages
      community.general.homebrew:
        name:
          - charmbracelet/tap/crush
          - dagger/tap/dagger
          - dagger/tap/container-use
          - frantjc/tap/forge
          - frantjc/tap/rvglsm
          - gh
          - go
          - golangci-lint
          - goreleaser
          - k9s
          - kind
          - kuberctx
          - kubernetes-cli
          - node
          # TODO(frantjc): spotdl in ~/.local/bin
          - pipx
          - upx
          - yq
        state: present

    - name: Install flatpak packages
      community.general.flatpak:
        method: user
        name:
          - at.vintagestory.VintageStory
          - chat.revolt.RevoltDesktop
          - com.github.iwalton3.jellyfin-media-player
          - https://mickael9.github.io/rvgl-flatpak/rvgl.flatpakref
        state: present
